import requests
from bs4 import BeautifulSoup
import requests
import re
from termcolor import colored

class ShodanScraper:
    def __init__(self, query, proxies):
        self.query = query
        self.proxies = proxies


    def veryfiy_page(self, response):
        if response.status_code != 200:
            print(colored("Error: Response code: {}".format(response.status_code), "red"))
            return False
        elif "Daily search usage limit reached" in response.text:
            print(colored("Daily search usage limit reached", "yellow"))
            return "Somewhat working"
        elif "Please create an account to view more results." in response.text:
            print(colored("Please create an account to view more results.", "yellow"))
            return False
        elif "Result limit reached." in response.text:
            print(colored("Result limit reached.", "yellow"))
            return False
    

    def search_shodan(self, index=1):
        self.index = index
        self.ip_addresses = []
        #loop through pages
        try:
            while True:
                query = self.query + '&page=' + str(self.index)
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36'
                    }
                url = 'http://www.shodan.io/search?query={}'.format(query)
                print("Searching Shodan for: {}".format(query))

                try:
                    proxy = self.proxies.get_proxies()
                    response = requests.get(url, proxies=proxy,headers=headers, timeout=5)
                except Exception as e:
                    print(colored("Error - switching proxy", "red"))
                    continue

                soup = BeautifulSoup(response.text, 'html.parser')
                proxy_string = str(proxy["http"][7:])

                if self.veryfiy_page(response) == False:
                    print("Error, switching proxy")
                    continue
                elif self.veryfiy_page(response) == "Somewhat working":
                    print(colored(f"Proxy somewhat working: {proxy}", "blue"))
                    with open("working_proxies.txt", "a") as file:
                        pass
                    with open("working_proxies.txt", "a") as file:
                        file.write(str(proxy_string) + "\n")
                    continue
                else:
                    print(colored(f"Proxy working: {proxy_string}", "green"))
                    with open("working_proxies.txt", "a") as file:
                        pass
                    with open("working_proxies.txt", "a") as file:
                        file.write(str(proxy_string) + "\n")
                    print(colored(soup.prettify(), "green"))
                    

                

                for div in soup.find_all("div", class_="heading"):
                    a = div.find("a", class_="title text-dark")
                    if a:
                        self.ip_addresses.append(a['href'][6:])
                
                if len(self.ip_addresses) == 0:
                    print("No IP addresses found for query: {}".format(query))
                

                if self.ip_addresses != []:
                    print(colored("IP addresses found for query: {}".format(query)+" found with proxy "+str(proxy_string), "green"))
                    print(colored(self.ip_addresses, "green"))
                    self.index += 1
                    filename = str(self.query) + "_ips.txt"
                    with open(filename, "a") as file:
                        pass
                    for ip in self.ip_addresses:
                        if ip not in open(filename).read():
                            with open(filename, "a") as file:
                                file.write(ip + "\n")
        except KeyboardInterrupt:
            return print(colored("Exiting", "red"))



    def list_ips(self):
        for ip in self.search_shodan() or []:
            print(ip)
            filename = str(self.query) + "_ips.txt"
            # if filename doesnt exist, create it
            with open(filename, "a") as file:
                pass
            # Code to execute if IP is in proper format and not in file
            if re.match(r"\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$", ip) and ip not in open(filename).read():
                with open(filename, "a") as file:
                    file.write(ip + "\n")

    def get_CVEs(self, exploitdb):
        filename = str(self.query) + "_ips.txt"
        #check for file existence
        try:
            with open(filename, "r") as file:
                pass
        except FileNotFoundError:
            return print("File not found")

        with open(filename, "r") as file:
            headers = {
                    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36'
                    }
            for ip in file:
                ip = ip.strip()
                print(ip)
                url = str("https://internetdb.shodan.io/"+ip)
                print(url)
                print("Searching CVE's for: {}".format(ip))
                try:
                    # Get response from Shodan API
                    response = requests.get(url).json()
                    #print(response)
                    cve_list = response["vulns"]

                    # Print scraped CVE's
                    print("CVE's found for IP address {}:".format(ip))
                    if len(cve_list) > 0:
                        print(colored(cve_list, "green"))
                    else:
                        print(colored(f"No CVE's found for IP address: {ip} :(", "red"))
                    # Search for exploits in ExploitDB
                    print(colored("Searching ExploitDB for exploits...", "light_magenta"))
                    for cve in cve_list:
                        result = exploitdb.search(cve)
                        if result != []:
                            print(colored(result, "green"))

                        
                    
                except Exception as e:
                    return print(e)
                