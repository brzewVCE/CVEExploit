import requests
from bs4 import BeautifulSoup
import requests
import re
from termcolor import colored

class Proxy:
    def __init__(self, protocol="http"):
        self.protocol = protocol
        if protocol == "http":
            self.get_proxy_list()

    def get_proxy_list(self):
        try:
            url = "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=http&timeout=10000&country=all&ssl=all&anonymity=all&auth="
            response = requests.get(url)
            filename = "http_proxies.txt"
            for ip in response.text.split('\n'):
                if ip not in open(filename).read():
                    with open(filename, "a") as file:
                        file.write(ip + "\n")
            ips_found = len(response.text.split('\n'))

            return print(colored(f"{ips_found} IP's saved to {filename}", "green"))
        except Exception as e:
            return print(e)
        
    def get_proxies(self):
        try:
            filename = str(self.protocol) + "_proxies.txt"
            #check if there are proxies left in the file
            with open(filename, "r") as file:
                proxy_list = file.readlines()
                if len(proxy_list) == 1:
                    print(colored(f"No more proxies left in {filename}, changing protocol to http and getting more proxies", "red"))
                    self.protocol = "http"
                    self.get_proxy_list()
                    filename = str(self.protocol) + "_proxies.txt"
            with open(filename, "r") as file:
                proxy_list = file.readlines()
                while not re.match(r"\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d{1,5}", proxy_list[0]):
                    del proxy_list[0]
                proxy = proxy_list[0].strip()
                del proxy_list[0]
            with open(filename, "w") as file:
                file.writelines(proxy_list)
            proxy = {
                "http": "http://"+str(proxy),
                "https": "http://"+str(proxy),
                }
            print(colored(f"Using proxy: {proxy}", "blue"))
            return proxy
        except Exception as e:
            return print(e)