import requests
from bs4 import BeautifulSoup
import requests
import re
from termcolor import colored


class Proxy:
    def __init__(self, proxy_source="default_http_proxies.txt"):
        self.proxy_source = proxy_source
        if proxy_source == "default_http_proxies.txt":
            self.get_proxy_list()

    def veryfiy_ip(self, ip):
        try:
            if re.match(r"\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d{1,5}", ip) == None:
                return False
            else:
                return True
        except Exception as e:
            return False

    def get_proxy_list(self):
        try:
            # create file if it doesn't exist
            with open(self.proxy_source, "a") as file:
                pass
            # get proxies from proxyscrape.com
            url = "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=http&timeout=10000&country=all&ssl=all&anonymity=all&auth="
            response = requests.get(url)
            # save proxies to file
            filename = str(self.proxy_source)
            for ip in response.text.split("\n"):
                if ip not in open(filename).read():
                    with open(filename, "a") as file:
                        file.write(ip + "\n")
            # count how many proxies were saved
            ips_found = len(response.text.split("\n"))

            return print(colored(f"{ips_found} IP's saved to {filename}", "green"))
        except Exception as e:
            return print(e)

    def get_proxies(self):
        try:
            filename = str(self.proxy_source)
            # check if there are proxies left in the file, switch to default if not
            with open(filename, "r") as file:
                proxy_list = file.readlines()
                while proxy_list[0] == "\n" or self.veryfiy_ip(proxy_list[0]) == False:
                    del proxy_list[0]

                if len(proxy_list) == 1:
                    print(
                        colored(
                            f"No avalible proxies in {filename}, changing proxy source to default and getting more proxies",
                            "red",
                        )
                    )
                    self.proxy_source = "default_http_proxies.txt"
                    self.get_proxy_list()
                    filename = str(self.proxy_source)
            # get proxy and remove it from the file
            with open(filename, "r") as file:
                proxy_list = file.readlines()
                while self.veryfiy_ip(proxy_list[0]) == False:
                    del proxy_list[0]
                proxy = proxy_list[0].strip()
                del proxy_list[0]
            with open(filename, "w") as file:
                file.writelines(proxy_list)
            # convert proxy to dict
            proxy = {
                "http": "http://" + str(proxy),
                "https": "http://" + str(proxy),
            }
            print(colored(f"Using proxy: {proxy}", "blue"))
            return proxy
        except Exception as e:
            return print(e)


if __name__ == "__main__":
    proxy = Proxy(proxy_source="working_proxies.txt")
    print(proxy.get_proxies())
